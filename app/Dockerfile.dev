# Development Dockerfile
FROM node:21.6.0-alpine

# Set working directory
WORKDIR /app

# Copy package files first for better cache utilization
COPY app/package*.json ./

# Install all dependencies including development tools
RUN npm install && \
    npm install -g nodemon ts-node tsconfig-paths

# Copy source and config files
COPY app/ ./

# Create non-root user
RUN addgroup -S appuser && adduser -S appuser -G appuser && \
    mkdir -p /home/appuser && \
    chown -R appuser:appuser /app /home/appuser

# Switch to non-root user
USER appuser

# Set environment variables
ENV NODE_ENV=development

# Expose the application port
EXPOSE 3000

# Copy tsconfig-paths bootstrap
COPY app/tsconfig-paths-bootstrap.js ./

# Use NODE_ENV=development to use dev configuration
ENV NODE_ENV=development

# Run the application in development mode with hot-reloading
CMD ["node", "-r", "ts-node/register", "-r", "./tsconfig-paths-bootstrap.js", "src/index.ts"]